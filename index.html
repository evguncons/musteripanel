<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEDEF AVM CRM | Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985' },
                        slate: { 850: '#1e293b' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; font-size: 15px; scroll-behavior: smooth; }
        .card-base { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .entry-card { background: #ffffff; border: 1px solid #cbd5e1; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.2s ease; }
        .entry-card:hover { border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1); }
        .input-label { display: block; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.5rem; }
        .input-field { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; font-weight: 500; color: #1e293b; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.85rem; outline: none; transition: all 0.2s; height: 48px; }
        .input-field:focus { background-color: #ffffff; border-color: #0ea5e9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .select-field { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.75rem; font-weight: 700; font-size: 0.95rem; border-radius: 0.85rem; transition: all 0.2s; cursor: pointer; height: 48px; border: none; }
        .btn-primary { background-color: #0ea5e9; color: white; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.25); }
        .btn-primary:hover { background-color: #0284c7; transform: translateY(-1px); }
        .btn-secondary { background-color: white; color: #475569; border: 1px solid #cbd5e1; }
        .loader { border: 3px solid #f1f5f9; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 1.75rem; height: 1.75rem; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .crown-icon {
            filter: drop-shadow(0 6px 12px rgba(234, 179, 8, 0.6));
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-12px); }
        }

        @media (max-width: 1024px) {
            .resp-table thead { display: none; }
            .resp-table tbody tr { display: flex; flex-direction: column; background: white; border: 1px solid #e2e8f0; border-radius: 1.25rem; margin-bottom: 1.25rem; padding: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
            .resp-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px dashed #f1f5f9; font-size: 0.95rem; }
            .resp-table td:last-child { border-bottom: none; padding-top: 1rem; }
            .resp-table td::before { content: attr(data-label); font-weight: 800; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-right: 1rem; }
        }
    </style>
</head>
<body class="pb-12 min-h-screen bg-slate-50 font-sans">

    <!-- LOGIN -->
    <div id="loginScreen" class="fixed inset-0 z-[100] bg-slate-100 flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-3xl shadow-2xl border border-slate-200 w-full max-w-md text-center">
            <div class="w-24 h-24 bg-gradient-to-br from-brand-600 to-indigo-700 rounded-2xl flex items-center justify-center shadow-lg text-white mx-auto mb-6 transform rotate-3">
                <i class="fas fa-lock text-4xl"></i>
            </div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">HEDEF AVM</h2>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-10">CRM SİSTEMİ GİRİŞ</p>
            <form id="loginForm" class="space-y-6">
                <input type="password" id="loginPass" class="input-field h-14 text-xl text-center tracking-widest" placeholder="Şifre">
                <button type="submit" class="btn btn-primary w-full h-14 text-lg">GİRİŞ YAP</button>
            </form>
            <p id="loginError" class="text-rose-500 text-sm font-bold mt-6 hidden">Hatalı Şifre!</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden max-w-[1600px] mx-auto px-4 md:px-8 pt-6 space-y-8">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm sticky top-4 z-40 backdrop-blur-md bg-white/90">
            <div class="flex items-center gap-5">
                <div class="w-14 h-14 bg-brand-600 rounded-2xl flex items-center justify-center text-white shadow-lg shrink-0">
                    <i class="fas fa-layer-group text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 leading-none tracking-tight">HEDEF AVM CRM</h1>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <select id="currentPeriod" onchange="refreshData()" class="bg-transparent border-none text-xs font-bold text-slate-500 uppercase tracking-wider outline-none cursor-pointer p-0 hover:text-brand-600 transition-colors">
                            <!-- JS ile doldurulacak -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-5 w-full md:w-auto justify-between md:justify-end">
                <div class="text-right px-4 border-r border-slate-100">
                    <span class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">SON VERİ</span>
                    <span id="lastUpdateTime" class="block text-sm font-bold text-slate-700 font-mono">--:--</span>
                </div>
                <button onclick="refreshData()" class="btn btn-secondary !h-12 !px-6 text-sm font-bold">
                    <i class="fas fa-sync-alt text-brand-500"></i> Yenile
                </button>
            </div>
        </header>

        <!-- DASHBOARD STATS -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6">
            <div class="card-base p-6 border-l-4 border-l-brand-500 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Toplam Yönlendirme</p>
                <h3 class="text-4xl font-black text-slate-800" id="globalTotalRecords">0</h3>
            </div>
            <div class="card-base p-6 border-l-4 border-l-indigo-400 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Toplam Aranan</p>
                <h3 class="text-4xl font-black text-indigo-600" id="globalTotalAranan">0</h3>
            </div>
            <div class="card-base p-6 border-l-4 border-l-emerald-500 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Toplam Satış</p>
                <h3 class="text-4xl font-black text-emerald-600" id="globalTotalSales">0</h3>
            </div>
            <div class="card-base p-6 border-l-4 border-l-amber-500 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Adet Lideri</p>
                <h3 class="text-lg font-bold text-slate-700 truncate mb-1" id="globalTopVolCat">-</h3>
                <span class="text-sm text-amber-600 font-extrabold uppercase" id="globalTopVolCount">0 Adet</span>
            </div>
            <div class="card-base p-6 border-l-4 border-l-rose-500 shadow-sm">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Ciro Lideri</p>
                <h3 class="text-lg font-bold text-slate-700 truncate mb-1" id="globalTopRevCat">-</h3>
                <span class="text-sm text-rose-600 font-extrabold uppercase" id="globalTopRevAmount">₺0</span>
            </div>
        </div>

        <!-- NEW ENTRY -->
        <section class="card-base shadow-sm border-t-4 border-t-brand-500">
            <div class="px-8 py-5 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                    <i class="fas fa-user-plus text-brand-500"></i> Yeni Müşteri Kaydı
                </h2>
            </div>
            <div class="p-6 md:p-8">
                <div id="inputContainer" class="space-y-6"></div>
                <div class="mt-8 pt-8 border-t border-slate-100 flex flex-col sm:flex-row justify-end gap-4">
                    <button onclick="addInputRow()" class="btn btn-secondary w-full sm:w-auto px-8"><i class="fas fa-plus"></i> Satır Ekle</button>
                    <button onclick="submitAllRows()" id="submitBtn" class="btn btn-primary w-full sm:w-auto px-12 text-lg">Kaydet ve Gönder</button>
                </div>
            </div>
        </section>

        <!-- PERFORMANCE SECTION -->
        <section class="card-base p-6 md:p-10 bg-white !overflow-visible">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-amber-100 text-amber-600 flex items-center justify-center shadow-sm text-2xl"><i class="fas fa-trophy"></i></div>
                    <div>
                        <h3 class="text-3xl font-black text-slate-800 tracking-tight">Şube Performans Ligi</h3>
                        <p class="text-sm font-bold text-slate-400 uppercase tracking-widest mt-1">Bu Ayın En İyileri</p>
                    </div>
                </div>
            </div>
            <div id="top3Container" class="flex justify-center items-end gap-3 md:gap-8 mb-16 mt-16 min-h-[300px] overflow-visible pb-4 px-2"></div>
            <div class="space-y-4" id="branchStatsBody">
                <div class="text-center py-10"><div class="loader mx-auto"></div></div>
            </div>
        </section>

        <!-- RECORD LIST -->
        <section class="card-base shadow-sm">
            <div class="p-8 border-b border-slate-100 bg-slate-50/50">
                <div class="flex flex-col md:flex-row justify-between gap-6 mb-8">
                    <h3 class="text-2xl font-black text-slate-800 tracking-tight">Müşteri İşlem Listesi</h3>
                    <div class="flex gap-3">
                         <span class="bg-brand-50 text-brand-700 px-4 py-1.5 rounded-full text-sm font-bold border border-brand-100 shadow-sm" id="totalRecordsBadge">0 Kayıt</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <div class="md:col-span-2">
                        <label class="input-label">Müşteri Arama (Ad Soyad veya Numara)</label>
                        <input type="text" id="searchName" placeholder="İsim veya telefon yazınız..." class="input-field" onkeyup="filterRecords()">
                    </div>
                    <div>
                        <label class="input-label">Şube</label>
                        <select id="filterBranch" class="input-field select-field" onchange="filterRecords()"><option value="all">Tüm Şubeler</option></select>
                    </div>
                    <div>
                        <label class="input-label">Arama Durumu</label>
                        <select id="filterStatus" class="input-field select-field" onchange="filterRecords()">
                            <option value="all">Tüm Durumlar</option>
                            <option value="Arandı">Arandı</option>
                            <option value="Aranmadı">Aranmadı</option>
                        </select>
                    </div>
                    <div class="flex items-end"><button onclick="clearFilters()" class="btn btn-secondary w-full text-sm">Temizle</button></div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left resp-table">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Tarih / Saat</th>
                            <th class="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Şube</th>
                            <th class="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Müşteri</th>
                            <th class="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Durum</th>
                            <th class="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Sonuç</th>
                            <th class="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest text-right">Tutar</th>
                            <th class="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest text-right">İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="crmTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                <span class="text-sm font-bold text-slate-500" id="paginationInfo">Sayfa 1 / 1</span>
                <div class="flex gap-3" id="paginationControls"></div>
            </div>
        </section>

        <!-- LATEST SALES -->
        <section class="card-base shadow-sm border-t-4 border-t-emerald-500">
            <div class="p-8 border-b border-slate-100 bg-gradient-to-b from-emerald-50/30 to-transparent flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-emerald-100 text-emerald-600 flex items-center justify-center shadow-sm text-2xl border border-emerald-200"><i class="fas fa-shopping-bag"></i></div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 tracking-tight">Son Satışlar</h3>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mt-1">Global Satış Akışı</p>
                    </div>
                </div>
                <span class="text-xs font-black bg-emerald-600 text-white px-4 py-2 rounded-xl shadow-lg shadow-emerald-200 animate-pulse flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-white"></span> CANLI AKIŞ</span>
            </div>
            <div id="latestSalesContainer" class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-h-[800px] overflow-y-auto custom-scrollbar">
                <div class="flex items-center justify-center py-20 col-span-full"><div class="loader"></div></div>
            </div>
        </section>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwRSKYdXIHm2A6uts8MJE0v6snp3rsSVm4Qk5yQRd9chXtGoMUCQGXZ37X05QUJY2Aq/exec';
        const CATEGORIES = ["Mobilya", "Baza+Yatak+Başlık", "Bebek ve Çocuk", "Beyaz Eşya", "Elektrikli Ev Aletleri", "Elektrikli-Benzinli Araç", "Elektronik", "Ev Dekorasyonu", "Halı", "Kişisel Aksesuar", "Mobilya Aksesuarı", "Tekstil", "Züccaciye", "Ayakkabı"];
        const MEDIA_CHANNELS = ["Instagram", "Whatsapp", "Facebook", "Çağrı", "Web Sitesi Form"];
        const TR_MONTHS = ['OCAK', 'ŞUBAT', 'MART', 'NİSAN', 'MAYIS', 'HAZİRAN', 'TEMMUZ', 'AĞUSTOS', 'EYLÜL', 'EKİM', 'KASIM', 'ARALIK'];

        let allRecordsData = [];
        let filteredData = [];
        let branchList = [];
        let currentPage = 1;
        const rowsPerPage = 12;

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if(btoa(document.getElementById('loginPass').value) === 'MTM0Njc5') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                initApp();
            } else document.getElementById('loginError').classList.remove('hidden');
        });

        async function initApp() {
            populatePeriodSelector();
            await fetchBranches();
            addInputRow();
            refreshData();
            setInterval(refreshData, 5000); 
        }

        function populatePeriodSelector() {
            const selector = document.getElementById('currentPeriod');
            const now = new Date();
            for (let i = -6; i <= 2; i++) {
                let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                let val = `${TR_MONTHS[d.getMonth()]} ${d.getFullYear()}`;
                let opt = document.createElement('option');
                opt.value = val; opt.textContent = val;
                if (i === 0) opt.selected = true;
                selector.appendChild(opt);
            }
        }

        async function fetchBranches() {
            try {
                const res = await fetch(`${API_URL}?action=getLeaderboard`);
                const data = await res.json();
                branchList = data.leaderboard.map(b => b.branch);
                const filter = document.getElementById('filterBranch');
                branchList.forEach(b => filter.innerHTML += `<option value="${b}">${b}</option>`);
            } catch(e) {}
        }

        function refreshData() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
            fetchData();
        }

        async function fetchData() {
            const period = document.getElementById('currentPeriod').value;
            try {
                const res = await fetch(`${API_URL}?action=getDashboardData&period=${encodeURIComponent(period)}&t=${Date.now()}`);
                const data = await res.json();
                allRecordsData = (data.records || []).sort((a, b) => {
                    const dateA = new Date(a.date.replace(' ', 'T'));
                    const dateB = new Date(b.date.replace(' ', 'T'));
                    return dateB - dateA;
                });
                updateStats(data.global);
                renderBranchPerformance(data.stats);
                renderLatestSales(data.sales || []);
                filterRecords();
            } catch(e) { console.error("Fetch hatası:", e); }
        }

        function updateStats(global) {
            if(!global) return;
            document.getElementById('globalTotalRecords').textContent = global.totalRecords || 0;
            document.getElementById('globalTotalAranan').textContent = global.totalAranan || 0;
            document.getElementById('globalTotalSales').textContent = global.totalSales || 0;
            document.getElementById('globalTopVolCat').textContent = global.topVolCat || '-';
            document.getElementById('globalTopVolCount').textContent = `${global.topVolCount || 0} Adet`;
            document.getElementById('globalTopRevCat').textContent = global.topRevCat || '-';
            document.getElementById('globalTopRevAmount').textContent = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(global.topRevAmount || 0);
        }

        function renderBranchPerformance(stats) {
            if(!stats) return;
            const container = document.getElementById('branchStatsBody');
            const podium = document.getElementById('top3Container');
            const sorted = [...stats].sort((a,b) => b.totalRevenue - a.totalRevenue);
            
            podium.innerHTML = '';
            const podiumOrder = [];
            if (sorted[1]) podiumOrder.push({ data: sorted[1], rank: 2 });
            if (sorted[0]) podiumOrder.push({ data: sorted[0], rank: 1 });
            if (sorted[2]) podiumOrder.push({ data: sorted[2], rank: 3 });

            const podiumStyles = {
                1: { bg: 'bg-gradient-to-b from-yellow-50/50 to-white', border: 'border-yellow-400', text: 'text-yellow-700', badge: 'bg-yellow-400', height: 'h-64', icon: 'https://www.upload.ee/image/18996886/king-crown-3d-icon-png-download-5666815.webp' },
                2: { bg: 'bg-gradient-to-b from-slate-50/50 to-white', border: 'border-slate-300', text: 'text-slate-600', badge: 'bg-slate-400', height: 'h-52', icon: 'https://www.upload.ee/image/18997018/Ads_z_tasar_m__40_.png' },
                3: { bg: 'bg-gradient-to-b from-orange-50/50 to-white', border: 'border-orange-300', text: 'text-orange-700', badge: 'bg-orange-400', height: 'h-44', icon: 'https://www.upload.ee/image/18997016/Ads_z_tasar_m__39_.png' }
            };

            podiumOrder.forEach(item => {
                const s = item.data; const rank = item.rank; const style = podiumStyles[rank];
                podium.innerHTML += `
                    <div class="relative flex flex-col items-center justify-end p-6 rounded-t-3xl border-t-4 border-x border-b ${style.border} ${style.bg} ${style.height} w-full min-w-[140px] md:max-w-[300px] shadow-sm text-center transition-all hover:scale-105 !overflow-visible">
                        <div class="absolute -top-20 left-1/2 -translate-x-1/2 w-28 h-28 flex items-center justify-center z-20 !overflow-visible">
                            <img src="${style.icon}" class="w-full h-full object-contain drop-shadow-xl ${rank===1?'crown-icon':''}">
                        </div>
                        <div class="mb-auto mt-12 w-full">
                             <div class="w-9 h-9 mx-auto rounded-full flex items-center justify-center ${style.badge} text-white font-black text-base mb-3 shadow-sm border-2 border-white">${rank}</div>
                             <h4 class="font-black text-slate-800 text-base md:text-lg leading-tight truncate px-1">${s.branch.replace(' Şubesi','')}</h4>
                        </div>
                        <div class="w-full border-t border-dashed border-slate-200/50 pt-4 mt-4">
                            <span class="block font-black ${style.text} text-lg md:text-xl tracking-tight">${new Intl.NumberFormat('tr-TR').format(s.totalRevenue)}₺</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = sorted.map((s, i) => `
                <div class="flex items-center justify-between p-6 bg-white border border-slate-100 rounded-2xl shadow-sm hover:border-brand-200 transition-all">
                    <div class="flex items-center gap-6">
                        <span class="text-base font-black text-slate-300 w-8">#${i+1}</span>
                        <span class="text-lg font-bold text-slate-700">${s.branch}</span>
                    </div>
                    <div class="flex items-center gap-12">
                        <div class="text-right hidden sm:block">
                            <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Arama Durumu</p>
                            <p class="text-base font-bold text-slate-600"><span class="text-brand-600">${s.arandi}</span> / <span class="text-slate-400">${s.aranmadi}</span></p>
                        </div>
                        <div class="text-right border-l border-slate-100 pl-8">
                            <p class="text-xl font-black text-slate-800">${new Intl.NumberFormat('tr-TR', { style:'currency', currency:'TRY', maximumFractionDigits:0 }).format(s.totalRevenue)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderLatestSales(sales) {
            const container = document.getElementById('latestSalesContainer');
            if (sales.length === 0) {
                container.innerHTML = '<div class="py-20 text-center col-span-full text-slate-400 italic">Henüz satış kaydı yok.</div>';
                return;
            }
            container.innerHTML = sales.map(s => {
                const amountFormatted = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(s.amount);
                const d = new Date(s.timestamp);
                const dateText = isNaN(d.getTime()) ? '' : `<span class="text-[10px] text-slate-400 font-bold ml-auto uppercase">${d.toLocaleDateString('tr-TR', {day:'numeric', month:'short'})} ${d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</span>`;
                return `
                    <div class="flex flex-col gap-4 p-6 rounded-2xl bg-white border border-slate-100 hover:border-emerald-400 hover:shadow-xl transition-all relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-50 rounded-bl-full -mr-10 -mt-10 z-0"></div>
                        <div class="flex justify-between items-start relative z-10">
                            <div class="w-11 h-11 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0 border border-emerald-200 shadow-sm"><i class="fas fa-check text-sm"></i></div>
                            ${dateText}
                        </div>
                        <div class="flex-1 min-w-0 relative z-10 mt-2">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">${s.branch.replace(' Şubesi','')}</span>
                            <h4 class="font-bold text-slate-800 text-base truncate">${s.name}</h4>
                            <div class="flex justify-between items-end border-t border-dashed border-slate-100 pt-4 mt-3">
                                <p class="text-xs text-slate-500 truncate max-w-[50%]">${s.product || s.category}</p>
                                <span class="text-sm font-black text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-lg border border-emerald-100">${amountFormatted}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterRecords() {
            const search = document.getElementById('searchName').value.toLowerCase();
            const branch = document.getElementById('filterBranch').value;
            const status = document.getElementById('filterStatus').value;
            filteredData = allRecordsData.filter(r => {
                const matchSearch = (r.name || '').toLowerCase().includes(search) || (r.contact || '').toLowerCase().includes(search);
                const matchBranch = branch === 'all' || r.branch === branch;
                const matchStatus = status === 'all' || (status === 'Arandı' && (r.status || '').toLowerCase() === 'arandı') || (status === 'Aranmadı' && (r.status || '').toLowerCase() !== 'arandı');
                return matchSearch && matchBranch && matchStatus;
            });
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('crmTableBody');
            document.getElementById('totalRecordsBadge').textContent = `${filteredData.length} Kayıt`;
            const start = (currentPage - 1) * rowsPerPage;
            const pageData = filteredData.slice(start, start + rowsPerPage);
            if (pageData.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="py-24 text-center text-slate-400">Kayıt yok.</td></tr>'; return; }
            tbody.innerHTML = pageData.map(r => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td data-label="Tarih / Saat" class="px-8 py-6 text-sm font-bold text-slate-600">${r.date}</td>
                    <td data-label="Şube" class="px-8 py-6"><span class="text-[12px] font-black text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg border border-indigo-100 uppercase">${r.branch.replace(' Şubesi','')}</span></td>
                    <td data-label="Müşteri" class="px-8 py-6 font-bold text-slate-800 text-base">${r.name}</td>
                    <td data-label="Durum" class="px-8 py-6"><span class="px-4 py-2 rounded-xl text-[12px] font-black border uppercase ${(r.status||'').toLowerCase()==='arandı'?'bg-brand-50 text-brand-700':'bg-slate-100 text-slate-500'}">${r.status}</span></td>
                    <td data-label="Sonuç" class="px-8 py-6 text-sm max-w-[200px] truncate">${r.result || '-'}</td>
                    <td data-label="Tutar" class="px-8 py-6 text-right font-black text-slate-800 text-base">${r.amount > 0 ? new Intl.NumberFormat('tr-TR').format(r.amount) + ' ₺' : '-'}</td>
                    <td data-label="İşlem" class="px-8 py-6 text-right">
                        <button onclick="setupEdit(${allRecordsData.indexOf(r)})" class="w-11 h-11 rounded-xl border border-slate-200 text-slate-400 hover:text-brand-600 transition-all"><i class="fas fa-pen text-sm"></i></button>
                    </td>
                </tr>
            `).join('');
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const container = document.getElementById('paginationControls');
            document.getElementById('paginationInfo').textContent = `Sayfa ${currentPage} / ${totalPages || 1}`;
            container.innerHTML = '';
            if(totalPages > 1) {
                const prev = document.createElement('button'); prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prev.className = `w-12 h-12 flex items-center justify-center rounded-xl border ${currentPage === 1 ? 'text-slate-200 bg-slate-50' : 'text-slate-600'}`;
                prev.onclick = () => { if(currentPage>1){ currentPage--; renderTable(); } };
                container.appendChild(prev);
                const next = document.createElement('button'); next.innerHTML = '<i class="fas fa-chevron-right"></i>';
                next.className = `w-12 h-12 flex items-center justify-center rounded-xl border ${currentPage === totalPages ? 'text-slate-200 bg-slate-50' : 'text-slate-600'}`;
                next.onclick = () => { if(currentPage<totalPages){ currentPage++; renderTable(); } };
                container.appendChild(next);
            }
        }

        function addInputRow() {
            const container = document.getElementById('inputContainer');
            const div = document.createElement('div');
            div.className = "entry-card bg-white shadow-sm border-2 border-slate-100";
            const bOpts = branchList.map(b => `<option value="${b}">${b}</option>`).join('');
            
            const now = new Date();
            const tzOffset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - tzOffset)).toISOString().slice(0, 16);

            div.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6 mb-6">
                    <div class="lg:col-span-2"><label class="input-label">Tarih</label><input type="datetime-local" class="input-field" value="${localISOTime}"></div>
                    <div class="lg:col-span-3"><label class="input-label">Şube</label><select class="input-field select-field inp-branch">${bOpts}</select></div>
                    <div class="lg:col-span-3"><label class="input-label">Müşteri</label><input type="text" class="input-field inp-name" placeholder="Ad Soyad"></div>
                    <div class="lg:col-span-2"><label class="input-label">İletişim</label><input type="text" class="input-field inp-contact" placeholder="Telefon"></div>
                    <div class="lg:col-span-2"><label class="input-label">Medya</label><select class="input-field select-field inp-media">${MEDIA_CHANNELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <div><label class="input-label">Kategori</label><select class="input-field select-field inp-category">${CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>
                    <div><label class="input-label">Ürün</label><input type="text" class="input-field inp-product" placeholder="Ürün Bilgisi"></div>
                    <div class="flex gap-4">
                        <select class="input-field select-field inp-status flex-1"><option value="aranmadı">Aranmadı</option><option value="arandı">Arandı</option></select>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-14 h-14 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center shrink-0 border border-rose-100 hover:bg-rose-100"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        async function submitAllRows() {
            const rows = document.querySelectorAll('#inputContainer > .entry-card');
            const data = [];
            rows.forEach(r => {
                const b = r.querySelector('.inp-branch').value;
                const n = r.querySelector('.inp-name').value;
                if(b && n) {
                    data.push({
                        date: r.querySelector('input[type="datetime-local"]').value.replace('T',' '),
                        branch: b, name: n,
                        contact: r.querySelector('.inp-contact').value,
                        media: r.querySelector('.inp-media').value,
                        category: r.querySelector('.inp-category').value,
                        product: r.querySelector('.inp-product').value,
                        status: r.querySelector('.inp-status').value
                    });
                }
            });
            if(data.length === 0) return;
            const btn = document.getElementById('submitBtn'); btn.disabled = true;
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addCustomersBulk', data: data }) });
                document.getElementById('inputContainer').innerHTML = ''; addInputRow(); refreshData();
            } catch(e) { alert("Sunucu ile bağlantı hatası oluştu."); }
            finally { btn.disabled = false; }
        }
    </script>
</body>
</html>
