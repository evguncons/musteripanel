<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEDEF AVM CRM | Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985' },
                        slate: { 850: '#1e293b' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
                        'gold': '0 20px 40px -5px rgba(234, 179, 8, 0.25)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; font-size: 14px; scroll-behavior: smooth; }
        .card-base { background: white; border-radius: 1.25rem; border: 1px solid #e2e8f0; overflow: hidden; }
        .entry-card { background: #ffffff; border: 1px solid #cbd5e1; border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; transition: all 0.2s ease; }
        .entry-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08); }
        .input-label { display: block; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.35rem; }
        .input-field { width: 100%; padding: 0.7rem 1rem; font-size: 0.9rem; font-weight: 500; color: #1e293b; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.75rem; outline: none; transition: all 0.2s; height: 42px; }
        .input-field:focus { background-color: #ffffff; border-color: #0ea5e9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .select-field { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; font-weight: 700; font-size: 0.9rem; border-radius: 0.75rem; transition: all 0.2s; cursor: pointer; height: 42px; border: none; }
        .btn-primary { background-color: #0ea5e9; color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.2); }
        .btn-primary:hover { background-color: #0284c7; transform: translateY(-1px); }
        .btn-secondary { background-color: white; color: #475569; border: 1px solid #cbd5e1; }
        .loader { border: 3px solid #f1f5f9; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .crown-icon {
            filter: drop-shadow(0 4px 6px rgba(234, 179, 8, 0.4));
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }

        @media (max-width: 1024px) {
            .resp-table thead { display: none; }
            .resp-table tbody tr { display: flex; flex-direction: column; background: white; border: 1px solid #e2e8f0; border-radius: 1rem; margin-bottom: 1rem; padding: 1rem; }
            .resp-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px dashed #f1f5f9; }
            .resp-table td:last-child { border-bottom: none; }
            .resp-table td::before { content: attr(data-label); font-weight: 800; font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="pb-12 min-h-screen bg-slate-50 font-sans">

    <!-- LOGIN -->
    <div id="loginScreen" class="fixed inset-0 z-[100] bg-slate-100 flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-3xl shadow-2xl border border-slate-200 w-full max-w-md text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-brand-600 to-indigo-700 rounded-2xl flex items-center justify-center shadow-lg text-white mx-auto mb-6 transform rotate-3">
                <i class="fas fa-lock text-3xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-1">HEDEF AVM</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-8">CRM SİSTEMİ GİRİŞ</p>
            <form id="loginForm" class="space-y-4">
                <input type="password" id="loginPass" class="input-field h-12 text-lg text-center tracking-widest" placeholder="Şifre">
                <button type="submit" class="btn btn-primary w-full h-12">GİRİŞ YAP</button>
            </form>
            <p id="loginError" class="text-rose-500 text-xs font-bold mt-4 hidden">Hatalı Şifre!</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden max-w-[1600px] mx-auto px-4 md:px-8 pt-6 space-y-8">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 bg-white p-5 rounded-3xl border border-slate-200 shadow-sm sticky top-4 z-40 backdrop-blur-md bg-white/90">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shrink-0">
                    <i class="fas fa-layer-group text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black text-slate-800 leading-none">HEDEF AVM CRM</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <select id="currentPeriod" onchange="refreshData()" class="bg-transparent border-none text-[10px] font-bold text-slate-400 uppercase tracking-tighter outline-none cursor-pointer p-0">
                            <!-- JS ile doldurulacak -->
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                <div class="text-right px-3 border-r border-slate-100">
                    <span class="block text-[9px] font-black text-slate-400 uppercase tracking-widest">SON VERİ</span>
                    <span id="lastUpdateTime" class="block text-xs font-bold text-slate-700 font-mono">--:--</span>
                </div>
                <button onclick="refreshData()" class="btn btn-secondary !h-10 !px-4 text-xs font-bold">
                    <i class="fas fa-sync-alt text-brand-500"></i> Yenile
                </button>
            </div>
        </header>

        <!-- DASHBOARD STATS -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card-base p-5 border-l-4 border-l-brand-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Toplam Aranan</p>
                <h3 class="text-2xl font-black text-slate-800" id="globalTotalAranan">0</h3>
            </div>
            <div class="card-base p-5 border-l-4 border-l-emerald-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Toplam Satış</p>
                <h3 class="text-2xl font-black text-emerald-600" id="globalTotalSales">0</h3>
            </div>
            <div class="card-base p-5 border-l-4 border-l-amber-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Adet Lideri</p>
                <h3 class="text-sm font-bold text-slate-700 truncate" id="globalTopVolCat">-</h3>
                <span class="text-[10px] text-amber-600 font-bold" id="globalTopVolCount">0 Adet</span>
            </div>
            <div class="card-base p-5 border-l-4 border-l-indigo-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Ciro Lideri</p>
                <h3 class="text-sm font-bold text-slate-700 truncate" id="globalTopRevCat">-</h3>
                <span class="text-[10px] text-indigo-600 font-bold" id="globalTopRevAmount">₺0</span>
            </div>
        </div>

        <!-- NEW ENTRY -->
        <section class="card-base shadow-sm border-t-4 border-t-brand-500">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                <h2 class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-user-plus text-brand-500"></i> Yeni Müşteri Kaydı
                </h2>
            </div>
            <div class="p-6">
                <div id="inputContainer" class="space-y-4"></div>
                <div class="mt-6 pt-6 border-t border-slate-100 flex flex-col sm:flex-row justify-end gap-3">
                    <button onclick="addInputRow()" class="btn btn-secondary w-full sm:w-auto px-6"><i class="fas fa-plus"></i> Satır Ekle</button>
                    <button onclick="submitAllRows()" id="submitBtn" class="btn btn-primary w-full sm:w-auto px-10">Kaydet ve Gönder</button>
                </div>
            </div>
        </section>

        <!-- PERFORMANCE SECTION -->
        <section class="card-base p-6">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center shadow-sm"><i class="fas fa-trophy"></i></div>
                <div><h3 class="text-lg font-bold text-slate-800">Şube Performans Ligi</h3><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Bu Ayın En İyileri</p></div>
            </div>

            <!-- PODIUM CONTAINER -->
            <div id="top3Container" class="flex justify-center items-end gap-2 md:gap-4 mb-12 mt-4 min-h-[220px]">
                <!-- Dinamik Doldurulacak -->
            </div>

            <div class="space-y-3" id="branchStatsBody">
                <div class="text-center py-10"><div class="loader mx-auto"></div></div>
            </div>
        </section>

        <!-- RECORD LIST -->
        <section class="card-base">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                    <h3 class="font-bold text-slate-800">Müşteri İşlem Listesi</h3>
                    <div class="flex gap-2">
                         <span class="bg-brand-50 text-brand-700 px-3 py-1 rounded-full text-xs font-bold border border-brand-100" id="totalRecordsBadge">0 Kayıt</span>
                    </div>
                </div>
                <!-- FILTERS -->
                <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    <div class="md:col-span-2"><input type="text" id="searchName" placeholder="Müşteri Adı..." class="input-field" onkeyup="filterRecords()"></div>
                    <div><select id="filterBranch" class="input-field select-field" onchange="filterRecords()"><option value="all">Tüm Şubeler</option></select></div>
                    <div>
                        <select id="filterStatus" class="input-field select-field" onchange="filterRecords()">
                            <option value="all">Tüm Durumlar</option>
                            <option value="Arandı">Arandı</option>
                            <option value="Aranmadı">Aranmadı</option>
                        </select>
                    </div>
                    <div><button onclick="clearFilters()" class="btn btn-secondary w-full text-xs">Temizle</button></div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left resp-table">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase">Tarih / Saat</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase">Şube</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase">Müşteri</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase">Durum</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase">Sonuç</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase text-right">Tutar</th>
                            <th class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase text-right">İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="crmTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-500" id="paginationInfo">Sayfa 1</span>
                <div class="flex gap-2" id="paginationControls"></div>
            </div>
        </section>

    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="card-base w-full max-w-lg shadow-2xl bg-white max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 sticky top-0 z-10">
                <h3 class="font-black text-slate-800">KAYIT DÜZENLE</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-rose-500"><i class="fas fa-times"></i></button>
            </div>
            <form id="editForm" class="p-8 space-y-4">
                <input type="hidden" id="modalRowIndex">
                <input type="hidden" id="modalSheetName">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="input-label">Tarih</label><input type="text" id="modalDate" class="input-field bg-slate-100" readonly></div>
                    <div><label class="input-label">Şube</label><input type="text" id="modalBranch" class="input-field bg-slate-100" readonly></div>
                </div>
                <div><label class="input-label">Müşteri Adı</label><input type="text" id="modalName" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="input-label">İletişim</label><input type="text" id="modalContact" class="input-field"></div>
                    <div><label class="input-label">Durum</label>
                        <select id="modalStatus" class="input-field select-field">
                            <option value="aranmadı">Aranmadı</option>
                            <option value="arandı">Arandı</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="input-label">Kategori</label><select id="modalCategory" class="input-field select-field"></select></div>
                    <div><label class="input-label">Medya</label><select id="modalMedia" class="input-field select-field"></select></div>
                </div>
                <div><label class="input-label">Ürün Bilgisi</label><input type="text" id="modalProduct" class="input-field"></div>
                <div class="p-4 bg-blue-50 rounded-xl space-y-3 border border-blue-100">
                    <div><label class="input-label text-blue-800">Görüşme Sonucu</label>
                        <select id="modalResult" class="input-field select-field border-blue-200">
                            <option value="">Seçiniz...</option>
                            <option value="Müşteri Mağazaya Gelecek">Müşteri Mağazaya Gelecek</option>
                            <option value="Bilgi verildi, olumsuz">Bilgi verildi, olumsuz</option>
                            <option value="Satışa Döndü">Satışa Döndü</option>
                            <option value="Tekrar Aranacak">Tekrar Aranacak</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="input-label text-emerald-800">Sipariş</label><select id="modalOrder" class="input-field select-field border-emerald-200"><option value="Hayır">Hayır</option><option value="Evet,Satış Yapıldı">Evet,Satış Yapıldı</option></select></div>
                        <div><label class="input-label text-emerald-800">Tutar (TL)</label><input type="number" id="modalAmount" class="input-field font-bold text-emerald-700 border-emerald-200"></div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Vazgeç</button>
                    <button type="submit" id="editSubmitBtn" class="btn btn-primary px-8">Güncelle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DELETE CONFIRM -->
    <div id="deleteModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="card-base w-full max-w-sm p-8 text-center bg-white">
            <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 border border-rose-100"><i class="fas fa-trash-alt text-xl"></i></div>
            <h3 class="font-black text-slate-800 mb-2">Emin misiniz?</h3>
            <p class="text-xs text-slate-500 mb-6">Bu kayıt tamamen silinecektir.</p>
            <input type="hidden" id="deleteIndex">
            <div class="flex gap-2">
                <button onclick="closeDeleteModal()" class="btn btn-secondary flex-1">İptal</button>
                <button onclick="confirmDelete()" id="btnConfirmDelete" class="btn btn-primary bg-rose-600 flex-1">Sil</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwRSKYdXIHm2A6uts8MJE0v6snp3rsSVm4Qk5yQRd9chXtGoMUCQGXZ37X05QUJY2Aq/exec';
        const CATEGORIES = ["Mobilya", "Baza+Yatak+Başlık", "Bebek ve Çocuk", "Beyaz Eşya", "Elektrikli Ev Aletleri", "Elektrikli-Benzinli Araç", "Elektronik", "Ev Dekorasyonu", "Halı", "Kişisel Aksesuar", "Mobilya Aksesuarı", "Tekstil", "Züccaciye", "Ayakkabı"];
        const MEDIA_CHANNELS = ["Instagram", "Whatsapp", "Facebook", "Çağrı", "Web Sitesi Form"];
        const TR_MONTHS = ['OCAK', 'ŞUBAT', 'MART', 'NİSAN', 'MAYIS', 'HAZİRAN', 'TEMMUZ', 'AĞUSTOS', 'EYLÜL', 'EKİM', 'KASIM', 'ARALIK'];

        let allRecordsData = [];
        let filteredData = [];
        let branchList = [];
        let currentPage = 1;
        const rowsPerPage = 12;

        // Login
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const pass = document.getElementById('loginPass').value;
            if(btoa(pass) === 'MTM0Njc5') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                initApp();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        async function initApp() {
            populatePeriodSelector();
            await fetchBranches();
            addInputRow();
            refreshData();
            setInterval(refreshData, 60000); 
        }

        function populatePeriodSelector() {
            const selector = document.getElementById('currentPeriod');
            const now = new Date();
            for (let i = -6; i <= 2; i++) {
                let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                let val = `${TR_MONTHS[d.getMonth()]} ${d.getFullYear()}`;
                let opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                if (i === 0) opt.selected = true;
                selector.appendChild(opt);
            }
        }

        async function fetchBranches() {
            try {
                const res = await fetch(`${API_URL}?action=getLeaderboard`);
                const data = await res.json();
                branchList = data.leaderboard.map(b => b.branch);
                const filter = document.getElementById('filterBranch');
                branchList.forEach(b => filter.innerHTML += `<option value="${b}">${b}</option>`);
            } catch(e) {}
        }

        function refreshData() {
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
            fetchData();
        }

        async function fetchData() {
            const period = document.getElementById('currentPeriod').value;
            try {
                const res = await fetch(`${API_URL}?action=getDashboardData&period=${encodeURIComponent(period)}&t=${Date.now()}`);
                const data = await res.json();
                
                // VERİ SIRALAMA (En yeni en üstte)
                allRecordsData = (data.records || []).sort((a, b) => {
                    const dateA = new Date(a.date.replace(' ', 'T'));
                    const dateB = new Date(b.date.replace(' ', 'T'));
                    return dateB - dateA;
                });

                updateStats(data.global);
                renderBranchPerformance(data.stats);
                filterRecords();
            } catch(e) {
                console.error("Fetch hatası:", e);
            }
        }

        function updateStats(global) {
            if(!global) return;
            document.getElementById('globalTotalAranan').textContent = global.totalAranan || 0;
            document.getElementById('globalTotalSales').textContent = global.totalSales || 0;
            document.getElementById('globalTopVolCat').textContent = global.topVolCat || '-';
            document.getElementById('globalTopVolCount').textContent = `${global.topVolCount || 0} Adet`;
            document.getElementById('globalTopRevCat').textContent = global.topRevCat || '-';
            document.getElementById('globalTopRevAmount').textContent = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(global.topRevAmount || 0);
        }

        function renderBranchPerformance(stats) {
            if(!stats) return;
            const container = document.getElementById('branchStatsBody');
            const podium = document.getElementById('top3Container');
            
            const sorted = [...stats].sort((a,b) => b.totalRevenue - a.totalRevenue);
            
            // PODIUM RENDER
            podium.innerHTML = '';
            const podiumOrder = [];
            if (sorted[1]) podiumOrder.push({ data: sorted[1], rank: 2 });
            if (sorted[0]) podiumOrder.push({ data: sorted[0], rank: 1 });
            if (sorted[2]) podiumOrder.push({ data: sorted[2], rank: 3 });

            const podiumStyles = {
                1: { bg: 'bg-gradient-to-b from-yellow-50 to-white', border: 'border-yellow-400', text: 'text-yellow-700', badge: 'bg-yellow-400', height: 'h-48', icon: 'https://www.upload.ee/image/18996886/king-crown-3d-icon-png-download-5666815.webp' },
                2: { bg: 'bg-gradient-to-b from-slate-50 to-white', border: 'border-slate-300', text: 'text-slate-600', badge: 'bg-slate-400', height: 'h-40', icon: 'https://www.upload.ee/image/18997018/Ads_z_tasar_m__40_.png' },
                3: { bg: 'bg-gradient-to-b from-orange-50 to-white', border: 'border-orange-300', text: 'text-orange-700', badge: 'bg-orange-400', height: 'h-36', icon: 'https://www.upload.ee/image/18997016/Ads_z_tasar_m__39_.png' }
            };

            podiumOrder.forEach(item => {
                const s = item.data;
                const rank = item.rank;
                const style = podiumStyles[rank];
                const cleanName = s.branch.replace(' Şubesi','');

                podium.innerHTML += `
                    <div class="relative flex flex-col items-center justify-end p-4 rounded-t-2xl border-t-4 border-x border-b ${style.border} ${style.bg} ${style.height} w-1/3 max-w-[280px] shadow-sm text-center transition-all hover:scale-105">
                        <div class="absolute -top-14 left-1/2 transform -translate-x-1/2 w-20 h-20 flex items-center justify-center z-20">
                            <img src="${style.icon}" class="w-full h-full object-contain drop-shadow-lg ${rank===1?'crown-icon':''}">
                        </div>
                        <div class="mb-auto mt-8 w-full">
                             <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center ${style.badge} text-white font-black text-[10px] mb-1">${rank}</div>
                             <h4 class="font-extrabold text-slate-800 text-[11px] leading-tight truncate px-1">${cleanName}</h4>
                        </div>
                        <div class="w-full border-t border-dashed border-slate-200/50 pt-2 mt-2">
                            <span class="block font-black ${style.text} text-sm">${new Intl.NumberFormat('tr-TR').format(s.totalRevenue)}₺</span>
                        </div>
                    </div>
                `;
            });

            // LIST RENDER
            container.innerHTML = sorted.map((s, i) => `
                <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl shadow-sm hover:border-brand-200 transition-all">
                    <div class="flex items-center gap-4">
                        <span class="text-xs font-bold text-slate-300 w-4">#${i+1}</span>
                        <span class="text-sm font-bold text-slate-700">${s.branch}</span>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-right">
                            <p class="text-[9px] font-bold text-slate-400 uppercase">Arama Durumu</p>
                            <p class="text-[11px] font-bold text-slate-600">${s.arandi} Arandı / ${s.aranmadi} Aranmadı</p>
                        </div>
                        <div class="text-right border-l border-slate-100 pl-4">
                            <p class="text-[9px] font-bold text-slate-400 uppercase">Ciro</p>
                            <p class="text-sm font-black text-slate-800">${new Intl.NumberFormat('tr-TR', { style:'currency', currency:'TRY', maximumFractionDigits:0 }).format(s.totalRevenue)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterRecords() {
            const search = document.getElementById('searchName').value.toLowerCase();
            const branch = document.getElementById('filterBranch').value;
            const status = document.getElementById('filterStatus').value;

            filteredData = allRecordsData.filter(r => {
                const matchName = (r.name || '').toLowerCase().includes(search);
                const matchBranch = branch === 'all' || r.branch === branch;
                const matchStatus = status === 'all' || 
                                   (status === 'Arandı' && (r.status || '').toLowerCase() === 'arandı') ||
                                   (status === 'Aranmadı' && (r.status || '').toLowerCase() !== 'arandı');
                return matchName && matchBranch && matchStatus;
            });
            currentPage = 1;
            renderTable();
        }

        // TARİH FORMATLAYICI (GG.AA.YYYY SS:DD)
        function formatDateDisplay(dateStr) {
            if (!dateStr) return "-";
            try {
                const d = new Date(dateStr.replace(' ', 'T'));
                if (isNaN(d.getTime())) return dateStr;
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                return `${day}.${month}.${year} ${hours}:${minutes}`;
            } catch (e) {
                return dateStr;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('crmTableBody');
            document.getElementById('totalRecordsBadge').textContent = `${filteredData.length} Kayıt`;
            
            const start = (currentPage - 1) * rowsPerPage;
            const pageData = filteredData.slice(start, start + rowsPerPage);
            
            tbody.innerHTML = pageData.map((r, i) => {
                const isArandi = (r.status || '').toLowerCase() === 'arandı';
                const statusColor = isArandi ? 'bg-brand-50 text-brand-700 border-brand-100' : 'bg-slate-100 text-slate-500 border-slate-200';
                const amount = r.amount > 0 ? new Intl.NumberFormat('tr-TR').format(r.amount) + ' ₺' : '-';
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td data-label="Tarih / Saat" class="px-6 py-4 text-xs font-bold text-slate-600">${formatDateDisplay(r.date)}</td>
                        <td data-label="Şube" class="px-6 py-4"><span class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md border border-indigo-100 uppercase">${r.branch.replace(' Şubesi','')}</span></td>
                        <td data-label="Müşteri" class="px-6 py-4 font-bold text-slate-800">${r.name}</td>
                        <td data-label="Durum" class="px-6 py-4"><span class="px-2.5 py-1 rounded-lg text-[10px] font-black border uppercase ${statusColor}">${r.status}</span></td>
                        <td data-label="Sonuç" class="px-6 py-4 text-xs font-medium text-slate-600 max-w-[150px] truncate">${r.result || '-'}</td>
                        <td data-label="Tutar" class="px-6 py-4 text-right font-black text-slate-800">${amount}</td>
                        <td data-label="İşlem" class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="setupEdit(${start + i})" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-brand-600 hover:border-brand-300 shadow-sm"><i class="fas fa-pen text-[10px]"></i></button>
                                <button onclick="setupDelete(${start + i})" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-rose-500 hover:border-rose-300 shadow-sm"><i class="fas fa-trash text-[10px]"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            renderPagination();
        }

        function renderPagination() {
            const pages = Math.ceil(filteredData.length / rowsPerPage);
            const container = document.getElementById('paginationControls');
            document.getElementById('paginationInfo').textContent = `Sayfa ${currentPage} / ${pages || 1}`;
            container.innerHTML = '';
            
            if(pages > 1) {
                const prev = document.createElement('button');
                prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prev.className = `w-8 h-8 flex items-center justify-center rounded-lg border ${currentPage === 1 ? 'text-slate-200 border-slate-100' : 'text-slate-600 border-slate-200 hover:bg-white shadow-sm'}`;
                prev.disabled = currentPage === 1;
                prev.onclick = () => { currentPage--; renderTable(); };
                container.appendChild(prev);

                const next = document.createElement('button');
                next.innerHTML = '<i class="fas fa-chevron-right"></i>';
                next.className = `w-8 h-8 flex items-center justify-center rounded-lg border ${currentPage === pages ? 'text-slate-200 border-slate-100' : 'text-slate-600 border-slate-200 hover:bg-white shadow-sm'}`;
                next.disabled = currentPage === pages;
                next.onclick = () => { currentPage++; renderTable(); };
                container.appendChild(next);
            }
        }

        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('filterBranch').value = 'all';
            document.getElementById('filterStatus').value = 'all';
            filterRecords();
        }

        function addInputRow() {
            const container = document.getElementById('inputContainer');
            const div = document.createElement('div');
            div.className = "entry-card bg-slate-50/30 border-dashed";
            const bOpts = branchList.map(b => `<option value="${b}">${b}</option>`).join('');
            const cOpts = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            const mOpts = MEDIA_CHANNELS.map(m => `<option value="${m}">${m}</option>`).join('');
            
            div.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-3 mb-3">
                    <div class="lg:col-span-2"><label class="input-label">Tarih</label><input type="datetime-local" class="input-field" value="${new Date().toISOString().slice(0,16)}"></div>
                    <div class="lg:col-span-3"><label class="input-label">Şube</label><select class="input-field select-field inp-branch"><option value="" disabled selected>Seç...</option>${bOpts}</select></div>
                    <div class="lg:col-span-3"><label class="input-label">Müşteri Ad Soyad</label><input type="text" class="input-field inp-name"></div>
                    <div class="lg:col-span-2"><label class="input-label">İletişim</label><input type="text" class="input-field inp-contact" placeholder="05xx"></div>
                    <div class="lg:col-span-2"><label class="input-label">Medya</label><select class="input-field select-field inp-media">${mOpts}</select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                    <div><label class="input-label">Kategori</label><select class="input-field select-field inp-category">${cOpts}</select></div>
                    <div><label class="input-label">Ürün Bilgisi</label><input type="text" class="input-field inp-product"></div>
                    <div class="flex gap-2">
                        <div class="flex-1"><label class="input-label">Durum</label><select class="input-field select-field inp-status"><option value="aranmadı">Aranmadı</option><option value="arandı">Arandı</option></select></div>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-10 h-[42px] mt-auto rounded-lg bg-white border border-slate-200 text-rose-500 hover:bg-rose-50"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        async function submitAllRows() {
            const rows = document.querySelectorAll('#inputContainer > .entry-card');
            const data = [];
            rows.forEach(r => {
                const b = r.querySelector('.inp-branch').value;
                const n = r.querySelector('.inp-name').value;
                if(b && n) {
                    data.push({
                        date: r.querySelector('input[type="datetime-local"]').value.replace('T',' '),
                        branch: b,
                        name: n,
                        contact: r.querySelector('.inp-contact').value,
                        media: r.querySelector('.inp-media').value,
                        category: r.querySelector('.inp-category').value,
                        product: r.querySelector('.inp-product').value,
                        status: r.querySelector('.inp-status').value.toLowerCase()
                    });
                }
            });

            if(data.length === 0) return;
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = '<div class="loader !w-4 !h-4 border-t-white"></div>';
            
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addCustomersBulk', data: data }) });
                document.getElementById('inputContainer').innerHTML = '';
                addInputRow();
                refreshData();
            } catch(e) { alert("Hata oluştu."); }
            finally { btn.disabled = false; btn.textContent = "Kaydet ve Gönder"; }
        }

        window.setupEdit = (idx) => {
            const r = filteredData[idx];
            document.getElementById('modalRowIndex').value = r.rowIndex;
            document.getElementById('modalSheetName').value = r.sheetName;
            document.getElementById('modalDate').value = r.date;
            document.getElementById('modalBranch').value = r.branch;
            document.getElementById('modalName').value = r.name;
            document.getElementById('modalContact').value = r.contact;
            document.getElementById('modalStatus').value = (r.status || '').toLowerCase();
            
            const catSel = document.getElementById('modalCategory');
            catSel.innerHTML = CATEGORIES.map(c => `<option value="${c}" ${r.category === c ? 'selected' : ''}>${c}</option>`).join('');
            
            const medSel = document.getElementById('modalMedia');
            medSel.innerHTML = MEDIA_CHANNELS.map(m => `<option value="${m}" ${r.media === m ? 'selected' : ''}>${m}</option>`).join('');

            document.getElementById('modalProduct').value = r.product || '';
            document.getElementById('modalResult').value = r.result || '';
            document.getElementById('modalOrder').value = r.order || 'Hayır';
            document.getElementById('modalAmount').value = r.amount || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        };

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('editSubmitBtn');
            btn.disabled = true; btn.textContent = "...";
            const data = {
                action: 'updateCustomer',
                data: {
                    rowIndex: document.getElementById('modalRowIndex').value,
                    sheetName: document.getElementById('modalSheetName').value,
                    date: document.getElementById('modalDate').value,
                    branch: document.getElementById('modalBranch').value,
                    name: document.getElementById('modalName').value,
                    contact: document.getElementById('modalContact').value,
                    status: document.getElementById('modalStatus').value.toLowerCase(),
                    category: document.getElementById('modalCategory').value,
                    media: document.getElementById('modalMedia').value,
                    product: document.getElementById('modalProduct').value,
                    result: document.getElementById('modalResult').value,
                    order: document.getElementById('modalOrder').value,
                    amount: document.getElementById('modalAmount').value
                }
            };
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
                closeEditModal();
                refreshData();
            } catch(e) {} finally { btn.disabled = false; btn.textContent = "Güncelle"; }
        });

        window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');
        window.closeDeleteModal = () => document.getElementById('deleteModal').classList.add('hidden');

        window.setupDelete = (idx) => {
            const r = filteredData[idx];
            document.getElementById('deleteIndex').dataset.rowIndex = r.rowIndex;
            document.getElementById('deleteIndex').dataset.sheetName = r.sheetName;
            document.getElementById('deleteIndex').dataset.branch = r.branch;
            document.getElementById('deleteModal').classList.remove('hidden');
        };

        window.confirmDelete = async () => {
            const el = document.getElementById('deleteIndex');
            const btn = document.getElementById('btnConfirmDelete');
            btn.disabled = true;
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({
                    action: 'deleteCustomer',
                    data: { rowIndex: el.dataset.rowIndex, sheetName: el.dataset.sheetName, branch: el.dataset.branch }
                })});
                closeDeleteModal();
                refreshData();
            } catch(e) {} finally { btn.disabled = false; }
        };
    </script>
</body>
</html>
