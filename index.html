<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEDEF AVM ONLİNE SATIŞ YÖNLENDİRME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #eef2ff;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-main: #f8fafc;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-main);
            color: #1e293b; 
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Modern Card Styling */
        .glass-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        }

        /* Input Styling */
        .modern-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            background-color: #ffffff;
            transition: all 0.2s ease;
            color: #334155;
        }
        .modern-input:focus { 
            outline: none; 
            border-color: var(--primary); 
            ring: 2px;
            ring-color: rgba(79, 70, 229, 0.1);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Table Responsive Layout */
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .custom-table th { 
            color: #64748b; font-weight: 600; text-transform: uppercase; 
            font-size: 0.7rem; padding: 1rem 1.25rem; letter-spacing: 0.05em;
            border-bottom: 1px solid #f1f5f9;
            text-align: left;
        }
        .custom-table tbody tr {
            transition: background-color 0.2s;
        }
        .custom-table tbody tr:hover {
            background-color: #f8fafc;
        }
        .custom-table td { padding: 1rem 1.25rem; font-size: 0.875rem; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }

        /* Responsive Table (Cards for Mobile) */
        @media (max-width: 768px) {
            .custom-table, .custom-table tbody, .custom-table tr, .custom-table td { display: block; width: 100%; }
            .custom-table thead { display: none; }
            .custom-table tr {
                margin-bottom: 1rem;
                border: 1px solid #e2e8f0;
                border-radius: 1rem;
                background: #fff;
                overflow: hidden;
            }
            .custom-table td {
                text-align: right;
                padding: 0.75rem 1rem;
                position: relative;
                padding-left: 45%;
                border-bottom: 1px solid #f1f5f9;
            }
            .custom-table td:last-child { border-bottom: none; background: #f8fafc; }
            .custom-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 1rem;
                width: 40%;
                text-align: left;
                font-weight: 700;
                color: #94a3b8;
                font-size: 0.75rem;
                text-transform: uppercase;
            }
        }

        /* Input Grid Wrapper */
        .input-row-wrapper {
            background: #fff;
            padding: 1.25rem;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            align-items: end;
            margin-bottom: 1rem;
        }

        @media (min-width: 1280px) {
            .input-row-wrapper {
                grid-template-columns: 160px 160px 1.2fr 1.2fr 120px 160px 1fr 120px 50px;
            }
        }

        /* Buttons */
        .btn-modern { 
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.625rem 1.25rem; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem;
            transition: all 0.2s; cursor: pointer;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        .btn-ghost { color: var(--secondary); background: transparent; }
        .btn-ghost:hover { background: #f1f5f9; color: #1e293b; }

        /* Badge Styles */
        .badge {
            padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
        }
        .badge-success { background-color: #d1fae5; color: #065f46; }
        .badge-gray { background-color: #f1f5f9; color: #475569; }

        /* Animation */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide { animation: slideIn 0.3s ease forwards; }

        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 1.25rem; height: 1.25rem; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-[1700px] mx-auto">
        
        <!-- HEADER -->
        <header class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6">
            <div class="flex items-center gap-5">
                <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-xl shadow-indigo-100 shrink-0">
                    <i class="fas fa-layer-group text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl lg:text-2xl font-bold text-slate-800 tracking-tight">HEDEF AVM ONLİNE SATIŞ YÖNLENDİRME</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Sistem Aktif • v3.5 (Silme Eklendi)</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4 w-full lg:w-auto">
                <div class="hidden sm:flex flex-col items-end px-4 border-r border-slate-200">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Son Senkronizasyon</span>
                    <span id="lastUpdateTime" class="text-sm font-bold text-slate-700">--:--</span>
                </div>
                <button onclick="refreshData()" class="btn-modern btn-ghost flex-1 lg:flex-none border border-slate-200">
                    <i class="fas fa-sync-alt mr-2 text-indigo-500"></i> Verileri Tazele
                </button>
            </div>
        </header>

        <!-- INPUT SECTION -->
        <section class="glass-card mb-10 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="fas fa-edit text-indigo-500"></i>
                    Yeni Kayıt Girişi
                </h2>
                <button onclick="addInputRow()" class="text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-1"></i> Satır Ekle
                </button>
            </div>
            
            <div class="p-5">
                <div class="hidden xl:grid grid-cols-[160px_160px_1.2fr_1.2fr_120px_160px_1fr_120px_50px] gap-4 px-4 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                    <div>Tarih / Saat</div>
                    <div>Yönlendirilen Şube</div>
                    <div>Müşteri Ad Soyad</div>
                    <div>Telefon No</div>
                    <div>Geliş Kanalı</div>
                    <div>Ürün Kategorisi</div>
                    <div>Ürün Detayı</div>
                    <div>Ön Durum</div>
                    <div class="text-center">Sil</div>
                </div>

                <div id="inputContainer" class="space-y-3"></div>

                <div class="mt-8 flex flex-col sm:flex-row justify-end items-center gap-4">
                    <p class="text-xs text-slate-400 italic"><i class="fas fa-info-circle mr-1"></i> Saat bilgisi gönderim anında otomatik güncellenir.</p>
                    <button onclick="submitAllRows()" id="submitBtn" class="btn-modern btn-primary w-full sm:w-auto px-12 py-3.5 shadow-lg shadow-indigo-100">
                        <i class="fas fa-paper-plane mr-2"></i> KAYDET VE LİSTEYE GÖNDER
                    </button>
                </div>
            </div>
        </section>

        <!-- DASHBOARD GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- RECENT TRANSACTIONS -->
            <div class="lg:col-span-8">
                <div class="glass-card flex flex-col h-full">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <i class="fas fa-history text-indigo-500"></i>
                            Son İşlemler
                        </h3>
                        <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded">SON 10 KAYIT</span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Şube / Durum</th>
                                    <th>Müşteri Bilgisi</th>
                                    <th>Ürün / Kategori</th>
                                    <th class="text-right">Aksiyon</th>
                                </tr>
                            </thead>
                            <tbody id="crmTableBody">
                                <tr><td colspan="5" class="text-center text-slate-400 py-20">Veriler yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- LATEST SALES -->
            <div class="lg:col-span-4">
                <div class="glass-card bg-slate-50/30 border-dashed">
                    <div class="p-5 border-b border-slate-100 bg-white rounded-t-[1.25rem]">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <i class="fas fa-trophy text-amber-500"></i>
                            Başarılı Satışlar
                        </h3>
                        <p class="text-[10px] text-slate-400 font-medium uppercase mt-1 tracking-wider">Global Satış Akışı</p>
                    </div>
                    
                    <div id="latestSalesContainer" class="p-5 space-y-4 max-h-[600px] overflow-y-auto custom-scrollbar">
                        <div class="flex items-center justify-center py-10">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-end md:items-center justify-center p-0 md:p-4 bg-slate-900/50 backdrop-blur-sm transition-all">
        <div class="bg-white rounded-t-3xl md:rounded-2xl shadow-2xl w-full max-w-xl transform transition-all border border-slate-100 flex flex-col h-[85vh] md:h-auto overflow-hidden">
            <div class="px-6 py-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-edit"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800">Kayıt Detaylarını Düzenle</h3>
                </div>
                <button onclick="closeEditModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition-colors text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="overflow-y-auto p-6 flex-1 bg-white">
                <form id="editForm" class="space-y-6">
                    <input type="hidden" id="modalRowIndex">
                    <input type="hidden" id="modalSheetName">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">İşlem Tarihi</label>
                            <input type="text" id="modalDate" class="modern-input">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Yönlendirilen Şube</label>
                            <input type="text" id="modalBranch" class="modern-input bg-slate-50 text-slate-400 font-bold" readonly>
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Müşteri Adı Soyadı</label>
                        <input type="text" id="modalName" class="modern-input">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">İletişim Numarası</label>
                            <input type="text" id="modalContact" class="modern-input">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Müşteri Durumu</label>
                            <select id="modalStatus" class="modern-input">
                                <option>Aranmadı</option>
                                <option>Arandı</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Kategori</label>
                            <select id="modalCategory" class="modern-input">
                                <option>Mobilya</option>
                                <option>Baza+Yatak+Başlık</option>
                                <option>Bebek ve Çocuk</option>
                                <option>Beyaz Eşya</option>
                                <option>Elektrikli Ev Aletleri</option>
                                <option>Elektrikli-Benzinli Araç</option>
                                <option>Elektronik</option>
                                <option>Ev Dekorasyonu</option>
                                <option>Halı</option>
                                <option>Kişisel Aksesuar</option>
                                <option>Mobilya Aksesuarı</option>
                                <option>Tekstil</option>
                                <option>Züccaciye</option>
                                <option>Ayakkabı</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Ürün Modeli</label>
                            <input type="text" id="modalProduct" class="modern-input">
                        </div>
                    </div>
                </form>
            </div>

            <div class="p-6 border-t bg-slate-50 flex flex-col md:flex-row justify-end gap-3 shrink-0">
                <button onclick="closeEditModal()" class="btn-modern btn-ghost order-2 md:order-1">İşlemi İptal Et</button>
                <button type="submit" form="editForm" id="editSubmitBtn" class="btn-modern btn-primary px-10 order-1 md:order-2">Güncelle ve Kaydet</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="deleteModal" class="fixed inset-0 modal-overlay z-[60] hidden flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm transition-all">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Kaydı Silmek İstiyor musunuz?</h3>
            <p class="text-sm text-slate-500 mb-6">Bu işlem geri alınamaz ve ilgili kayıt tablodan kalıcı olarak silinir.</p>
            <input type="hidden" id="deleteIndex">
            <div class="flex gap-3 justify-center">
                <button onclick="closeDeleteModal()" class="btn-modern btn-ghost bg-slate-100 hover:bg-slate-200">Vazgeç</button>
                <button onclick="confirmDelete()" id="btnConfirmDelete" class="btn-modern btn-primary bg-rose-500 hover:bg-rose-600 text-white shadow-rose-200">Evet, Sil</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwRSKYdXIHm2A6uts8MJE0v6snp3rsSVm4Qk5yQRd9chXtGoMUCQGXZ37X05QUJY2Aq/exec'; 
        
        let branchList = [];
        let globalRecords = [];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchBranches();
            addInputRow(); // Start with one row
            refreshData();
            setInterval(refreshData, 45000); 
        });

        function refreshData() {
            const timeDisplay = document.getElementById('lastUpdateTime');
            const now = new Date();
            timeDisplay.textContent = now.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
            fetchRecentRecords(); 
            fetchLatestSales();
        }

        function getTodayDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        async function fetchBranches() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=getLeaderboard`);
                const data = await response.json();
                if(data.leaderboard) branchList = data.leaderboard.map(b => b.branch);
                
                // Update first row if it was added before branches loaded
                const firstSelect = document.querySelector('.inp-branch');
                if (firstSelect && firstSelect.options.length <= 1) {
                    let branchOptions = '<option value="" disabled selected>Şube Seçin</option>';
                    branchList.forEach(b => branchOptions += `<option value="${b}">${b}</option>`);
                    firstSelect.innerHTML = branchOptions;
                }
            } catch(e) { console.error("Branch fetch failed", e); }
        }

        // --- INPUT ROW MGMT ---
        function addInputRow() {
            const container = document.getElementById('inputContainer');
            const row = document.createElement('div');
            row.className = 'input-row-wrapper animate-slide';
            
            let branchOptions = '<option value="" disabled selected>Şube Seçin</option>';
            branchList.forEach(b => branchOptions += `<option value="${b}">${b}</option>`);

            row.innerHTML = `
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">Tarih</label>
                    <input type="datetime-local" class="modern-input inp-date" value="${getTodayDateTime()}">
                </div>
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">Şube</label>
                    <select class="modern-input inp-branch">${branchOptions}</select>
                </div>
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">Müşteri</label>
                    <input type="text" class="modern-input inp-name" placeholder="Ad Soyad">
                </div>
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">İletişim</label>
                    <input type="tel" class="modern-input inp-contact" placeholder="05XX XXX XX XX">
                </div>
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">Medya</label>
                    <select class="modern-input inp-media">
                        <option>Instagram</option><option>Whatsapp</option><option>Facebook</option><option>Çağrı</option><option>Web Form</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">Kategori</label>
                    <select class="modern-input inp-category">
                         <option>Mobilya</option>
                         <option>Baza+Yatak+Başlık</option>
                         <option>Bebek ve Çocuk</option>
                         <option>Beyaz Eşya</option>
                         <option>Elektrikli Ev Aletleri</option>
                         <option>Elektrikli-Benzinli Araç</option> 
                         <option>Elektronik</option>
                         <option>Ev Dekorasyonu</option>
                         <option>Halı</option>
                         <option>Kişisel Aksesuar</option> 
                         <option>Mobilya Aksesuarı</option> 
                         <option>Tekstil</option>
                         <option>Züccaciye</option>
                         <option>Ayakkabı</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">Ürün</label>
                    <input type="text" class="modern-input inp-product" placeholder="Marka/Model">
                </div>
                <div class="space-y-1">
                    <label class="xl:hidden text-[10px] font-bold text-slate-400 uppercase">Durum</label>
                    <select class="modern-input inp-status">
                        <option>Aranmadı</option><option>Arandı</option>
                    </select>
                </div>
                <div class="flex justify-center pb-1">
                    <button onclick="removeRow(this)" class="w-10 h-10 xl:w-8 xl:h-8 rounded-xl bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </button>
                </div>
            `;
            container.appendChild(row);
        }

        function removeRow(btn) {
            const container = document.getElementById('inputContainer');
            if(container.children.length > 1) {
                const row = btn.closest('.input-row-wrapper');
                row.classList.add('opacity-0', 'translate-x-4');
                setTimeout(() => row.remove(), 200);
            }
        }

        async function submitAllRows() {
            const rows = document.querySelectorAll('.input-row-wrapper');
            const dataToSend = [];
            let isValid = true;

            rows.forEach(row => {
                const branch = row.querySelector('.inp-branch').value;
                const name = row.querySelector('.inp-name').value;
                const dateVal = row.querySelector('.inp-date').value;
                
                let formattedDate = '';
                if (dateVal) {
                    const datePart = dateVal.split('T')[0];
                    const now = new Date();
                    const h = String(now.getHours()).padStart(2, '0');
                    const m = String(now.getMinutes()).padStart(2, '0');
                    formattedDate = `${datePart} ${h}:${m}`;
                }

                let cleanContact = row.querySelector('.inp-contact').value.replace(/\s/g, '').replace(/^\+90/, '');

                if(!branch || !name) {
                    row.classList.add('border-rose-400', 'bg-rose-50/20');
                    isValid = false;
                } else {
                    row.classList.remove('border-rose-400', 'bg-rose-50/20');
                    dataToSend.push({
                        date: formattedDate,
                        branch: branch,
                        name: name.trim(), 
                        contact: cleanContact,
                        media: row.querySelector('.inp-media').value,
                        category: row.querySelector('.inp-category').value,
                        product: row.querySelector('.inp-product').value,
                        status: row.querySelector('.inp-status').value
                    });
                }
            });

            if(!isValid) return alert("Lütfen zorunlu alanları (Şube ve İsim) doldurun.");
            
            const btn = document.getElementById('submitBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loader border-t-white mr-2"></span> İşleniyor...';
            btn.disabled = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: 'addCustomersBulk', data: dataToSend })
                });
                const result = await response.json();
                
                if(result.status === 'success') {
                    // Success UI
                    document.getElementById('inputContainer').innerHTML = ''; 
                    addInputRow();
                    refreshData();
                }
            } catch(e) {
                alert("Veri gönderilirken bir hata oluştu.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // --- DATA FETCH & RENDER ---
        async function fetchRecentRecords() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=getRecentRecords&t=${new Date().getTime()}`);
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                if (data.records) {
                    globalRecords = data.records; 
                    renderTable();
                } else {
                    renderTableError("Veri alınamadı veya liste boş.");
                }
            } catch(e) { 
                console.error("Records fetch failed", e); 
                renderTableError("Bağlantı Hatası: Lütfen URL'i kontrol edin.");
            }
        }

        function renderTableError(msg) {
             const tbody = document.getElementById('crmTableBody');
             tbody.innerHTML = `<tr><td colspan="5" class="text-center text-rose-500 py-16 font-medium"><i class="fas fa-exclamation-triangle mr-2"></i> ${msg}</td></tr>`;
        }

        function renderTable() {
            const tbody = document.getElementById('crmTableBody');
            tbody.innerHTML = '';
            
            if(!globalRecords || !Array.isArray(globalRecords) || globalRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-slate-400 py-16 font-medium">Kayıtlı işlem bulunamadı.</td></tr>';
                return;
            }

            globalRecords.slice(0, 10).forEach((data, index) => {
                const row = document.createElement('tr');
                row.className = 'group';
                
                const statusBadge = data.status === 'Arandı' ? 'badge-success' : 'badge-gray';
                const cleanBranch = data.branch ? data.branch.replace(/ Şubesi/gi, '') : '-';

                let dateDisplay = data.date || '';
                dateDisplay = dateDisplay.replace('T', ' '); 
                let datePart = dateDisplay.split(' ')[0] || '-';
                let timePart = dateDisplay.split(' ')[1] || '';
                if(timePart.length > 5) timePart = timePart.substring(0, 5);

                row.innerHTML = `
                    <td data-label="Tarih">
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700">${datePart}</span>
                            <span class="text-[10px] text-slate-400 font-bold">${timePart}</span>
                        </div>
                    </td>
                    <td data-label="Şube / Durum">
                        <div class="flex flex-col gap-1.5 items-end md:items-start">
                            <span class="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded">${cleanBranch}</span>
                            <span class="badge ${statusBadge}">${data.status || '-'}</span>
                        </div>
                    </td>
                    <td data-label="Müşteri Bilgisi">
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-800">${data.name || '-'}</span>
                            <span class="text-xs text-slate-500 font-medium">${data.contact || '-'}</span>
                        </div>
                    </td>
                    <td data-label="Ürün Detayı">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-indigo-600">${data.category || '-'}</span>
                            <span class="text-xs text-slate-400 truncate max-w-[150px]">${data.product || 'Belirtilmedi'}</span>
                        </div>
                    </td>
                    <td class="text-right">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="openEditModal(${index})" class="w-8 h-8 flex items-center justify-center rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors" title="Düzenle">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                            <button onclick="openDeleteModal(${index})" class="w-8 h-8 flex items-center justify-center rounded-lg bg-rose-50 text-rose-500 hover:bg-rose-100 transition-colors" title="Sil">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function fetchLatestSales() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=getLatestSalesGlobal&t=${new Date().getTime()}`);
                const data = await response.json();
                const container = document.getElementById('latestSalesContainer');
                
                if (data.sales && data.sales.length > 0) {
                    container.innerHTML = data.sales.map(s => {
                        const amountFormatted = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(s.amount);
                        const cleanBranch = s.branch.replace(/ Şubesi/gi, '');
                        
                        return `
                            <div class="flex items-start gap-4 p-4 rounded-2xl bg-white border border-slate-100 shadow-sm animate-slide">
                                <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center shrink-0">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${cleanBranch}</span>
                                        <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded">${amountFormatted}</span>
                                    </div>
                                    <h4 class="font-bold text-slate-800 text-sm truncate">${s.name}</h4>
                                    <p class="text-xs text-slate-400 font-medium mt-0.5">${s.category}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm font-medium">Henüz satış kaydı bulunmuyor.</div>';
                }
            } catch(e) { console.error("Sales fetch failed", e); }
        }

        // --- MODAL MGMT ---
        function openEditModal(index) {
            const data = globalRecords[index];
            document.getElementById('modalRowIndex').value = data.rowIndex;
            document.getElementById('modalSheetName').value = data.sheetName;
            document.getElementById('modalDate').value = data.date;
            document.getElementById('modalBranch').value = data.branch;
            document.getElementById('modalName').value = data.name;
            document.getElementById('modalContact').value = data.contact;
            document.getElementById('modalStatus').value = data.status;
            document.getElementById('modalCategory').value = data.category;
            document.getElementById('modalProduct').value = data.product || '';
            
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('editSubmitBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loader border-t-white mr-2"></span> Güncelleniyor...';
            btn.disabled = true;

            const formData = {
                action: 'updateCustomer',
                data: {
                    rowIndex: document.getElementById('modalRowIndex').value,
                    sheetName: document.getElementById('modalSheetName').value,
                    date: document.getElementById('modalDate').value,
                    branch: document.getElementById('modalBranch').value,
                    name: document.getElementById('modalName').value,
                    contact: document.getElementById('modalContact').value,
                    status: document.getElementById('modalStatus').value,
                    category: document.getElementById('modalCategory').value,
                    product: document.getElementById('modalProduct').value
                }
            };

            try {
                await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(formData)
                });
                closeEditModal();
                refreshData();
            } catch(e) {
                alert("Güncelleme sırasında bir hata oluştu.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        });

        // --- DELETE FUNCTIONS ---
        function openDeleteModal(index) {
            document.getElementById('deleteIndex').value = index;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function confirmDelete() {
            const index = document.getElementById('deleteIndex').value;
            const record = globalRecords[index];
            const btn = document.getElementById('btnConfirmDelete');
            const originalHTML = btn.innerHTML;

            btn.innerHTML = '<span class="loader border-t-white w-4 h-4 mr-2"></span> Siliniyor...';
            btn.disabled = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        action: 'deleteCustomer',
                        data: {
                            sheetName: record.sheetName,
                            rowIndex: record.rowIndex,
                            branch: record.branch 
                        }
                    })
                });
                const result = await response.json();
                if(result.status === 'success') {
                    closeDeleteModal();
                    refreshData();
                } else {
                    alert("Silme başarısız: " + (result.message || 'Bilinmeyen hata'));
                }
            } catch(e) {
                alert("Silme işleminde hata oluştu.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
